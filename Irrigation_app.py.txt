import streamlit as st
import pandas as pd
import pickle  # Assuming you saved your trained RF model

# --- 1. App Title & Description ---
st.set_page_config(page_title="Smart Irrigation System", page_icon="üíß")
st.title("üíß Smart Irrigation Scheduler")
st.markdown("AI-Driven Precision Farming for Kamshet Region")

# --- 2. Sidebar: Inputs ---
st.sidebar.header("Farm Parameters")
crop_type = st.sidebar.selectbox("Select Crop Type", ["Rice", "Wheat", "Tomato", "Sugarcane"])
farm_area = st.sidebar.number_input("Farm Area (Hectares)", min_value=0.1, value=1.0)
pump_rate = st.sidebar.number_input("Pump Flow Rate (Liters/Hour)", value=2000)

st.sidebar.header("Weather Conditions (Today)")
# In a real app, these would be fetched from an API automatically
temp_max = st.sidebar.slider("Max Temp (¬∞C)", 10.0, 45.0, 32.0)
humidity = st.sidebar.slider("Humidity (%)", 10, 100, 60)
wind_speed = st.sidebar.slider("Wind Speed (m/s)", 0.0, 15.0, 2.5)
radiation = st.sidebar.slider("Solar Radiation (MJ/m¬≤)", 5.0, 30.0, 18.0)

# --- 3. Logic Layer (Backend) ---
def calculate_irrigation(et0, crop, area, rate):
    # Crop Coefficients (Simplified)
    kc_map = {'Rice': 1.2, 'Wheat': 1.15, 'Tomato': 0.85, 'Sugarcane': 1.25}
    kc = kc_map.get(crop, 1.0)
    
    # Water Need Calculation
    water_mm = et0 * kc
    water_liters = water_mm * area * 10000  # 1mm = 10,000 L/ha
    
    # Runtime Calculation
    runtime_hours = water_liters / rate
    runtime_minutes = runtime_hours * 60
    
    return water_mm, water_liters, runtime_minutes

# --- 4. Main Dashboard ---
if st.button("Calculate Irrigation Schedule"):
    # Placeholder for ML Prediction (Replace with: model.predict([[temp_max, ...]])[0])
    # For demonstration, let's assume a dummy prediction logic or load your actual model
    predicted_et0 = 0.5 * temp_max * (1 - humidity/100) + (wind_speed * 0.2) # Dummy formula for UI demo
    
    water_need_mm, water_vol, run_time = calculate_irrigation(predicted_et0, crop_type, farm_area, pump_rate)
    
    # Display Results
    col1, col2, col3 = st.columns(3)
    col1.metric("Predicted ET0", f"{predicted_et0:.2f} mm/day")
    col2.metric("Water Required", f"{water_vol:,.0f} Liters")
    col3.metric("Pump Runtime", f"{run_time:.0f} Minutes")
    
    # Advice Box
    if run_time > 60:
        st.warning(f"‚ö†Ô∏è High Water Demand! Run pump for {int(run_time)} minutes. Check soil moisture manually.")
    else:
        st.success(f"‚úÖ Normal Condition. Run pump for {int(run_time)} minutes.")

    # Explanation (XAI Concept)
    st.info(f"Logic: Based on {crop_type} (Kc={1.2 if crop_type=='Rice' else '...'}) and current weather.")